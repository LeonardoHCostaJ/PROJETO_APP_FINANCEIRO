<section class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">Lançamentos</h1>
    <button class="btn btn-outline-secondary btn-sm"
            (click)="carregarTudo()" [disabled]="carregando()">
      <span *ngIf="carregando()" class="spinner-border spinner-border-sm me-2"></span>
      Recarregar
    </button>
  </div>

  <!-- Form criar -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form [formGroup]="form" (ngSubmit)="criar()" class="row g-2">
        <div class="col-12 col-xl-3">
          <input class="form-control" placeholder="Descrição" formControlName="descricao">
        </div>

        <div class="col-6 col-xl-1">
          <input class="form-control" placeholder="Parcela" formControlName="parcela">
        </div>

        <div class="col-6 col-xl-2">
          <input type="date" class="form-control" formControlName="dataLancamentoISO">
        </div>

        <div class="col-6 col-xl-2">
          <input type="date" class="form-control" formControlName="dataVencimentoISO">
        </div>

        <div class="col-6 col-xl-2">
          <input type="date" class="form-control" formControlName="dataBaixaISO">
        </div>

        <div class="col-6 col-xl-1">
          <input type="number" step="0.01" class="form-control" placeholder="Doc." formControlName="valorDocumento">
        </div>

        <div class="col-6 col-xl-1">
          <input type="number" step="0.01" class="form-control" placeholder="Baix." formControlName="valorBaixado">
        </div>

        <div class="col-6 col-xl-2">
          <select class="form-select" formControlName="tipoLancamento">
            <option *ngFor="let t of tipos" [value]="t">{{ t }}</option>
          </select>
        </div>

        <div class="col-6 col-xl-2">
          <select class="form-select" formControlName="situacao">
            <option *ngFor="let s of situacoes" [value]="s">{{ s }}</option>
          </select>
        </div>

        <div class="col-6 col-xl-3">
          <select class="form-select" formControlName="contaId">
            <option [ngValue]="null">– Conta –</option>
            <option *ngFor="let c of contas()" [ngValue]="c.id">{{ c.descricao || ('#' + c.id) }}</option>
          </select>
        </div>

        <div class="col-6 col-xl-3">
          <select class="form-select" formControlName="terceiroId">
            <option [ngValue]="null">– Terceiro –</option>
            <option *ngFor="let t of terceiros()" [ngValue]="t.id">{{ t.nome || t.razaoSocial || ('#' + t.id) }}</option>
          </select>
        </div>

        <div class="col-6 col-xl-3">
          <select class="form-select" formControlName="centroCustoId">
            <option [ngValue]="null">– Centro de Custo –</option>
            <option *ngFor="let cc of centros()" [ngValue]="cc.id">{{ cc.descricao || ('#' + cc.id) }}</option>
          </select>
        </div>

        <div class="col-12 col-xl-2 d-grid">
          <button class="btn btn-primary" type="submit" [disabled]="form.invalid || carregando()">Criar</button>
        </div>

        <div class="col-12" *ngIf="erro()">
          <div class="alert alert-danger mt-2 mb-0">{{ erro() }}</div>
        </div>
      </form>
    </div>
  </div>

  <!-- Filtro -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="p-3">
        <input class="form-control" placeholder="Filtrar por descrição / tipo / valor / conta / centro / terceiro..."
               (input)="filtro.set(($any($event.target).value ?? '').toString())">
      </div>

      <!-- Tabela -->
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:80px;">ID</th>
              <th>Descrição</th>
              <th style="width:120px;">Parcela</th>
              <th style="width:140px;">Lançamento</th>
              <th style="width:140px;">Vencimento</th>
              <th style="width:140px;">Baixa</th>
              <th style="width:120px;">Doc.</th>
              <th style="width:120px;">Baix.</th>
              <th style="width:140px;">Tipo</th>
              <th style="width:180px;">Conta</th>
              <th style="width:200px;">Centro Custo</th>
              <th style="width:200px;">Terceiro</th>
              <th style="width:140px;">Situação</th>
              <th class="text-end" style="width:180px;">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let l of listaFiltrada()">
              <td class="text-muted">#{{ l.id }}</td>

              <td><input class="form-control form-control-sm" [value]="l.descricao" #d></td>
              <td><input class="form-control form-control-sm" [value]="l.parcela" #par></td>

              <td><input type="date" class="form-control form-control-sm" [value]="l.dataLancamentoISO" #dl></td>
              <td><input type="date" class="form-control form-control-sm" [value]="l.dataVencimentoISO" #dv></td>
              <td><input type="date" class="form-control form-control-sm" [value]="l.dataBaixaISO" #db></td>

              <td><input type="number" step="0.01" class="form-control form-control-sm" [value]="l.valorDocumento" #vd></td>
              <td><input type="number" step="0.01" class="form-control form-control-sm" [value]="l.valorBaixado" #vb></td>

              <td>
                <select class="form-select form-select-sm"
                        [ngModel]="l.tipoLancamento"
                        [ngModelOptions]="{standalone:true}"
                        #tp="ngModel">
                  <option *ngFor="let t of tipos" [ngValue]="t">{{ t }}</option>
                </select>
              </td>

              <td>
                <select class="form-select form-select-sm"
                        [ngModel]="l.conta?.id ?? null"
                        [ngModelOptions]="{standalone:true}"
                        #conta="ngModel">
                  <option [ngValue]="null">–</option>
                  <option *ngFor="let c of contas()" [ngValue]="c.id">{{ c.descricao || ('#' + c.id) }}</option>
                </select>
              </td>

              <td>
                <select class="form-select form-select-sm"
                        [ngModel]="l.centroCusto?.id ?? null"
                        [ngModelOptions]="{standalone:true}"
                        #cc="ngModel">
                  <option [ngValue]="null">–</option>
                  <option *ngFor="let c of centros()" [ngValue]="c.id">{{ c.descricao || ('#' + c.id) }}</option>
                </select>
              </td>

              <td>
                <select class="form-select form-select-sm"
                        [ngModel]="l.terceiro?.id ?? null"
                        [ngModelOptions]="{standalone:true}"
                        #ter="ngModel">
                  <option [ngValue]="null">–</option>
                  <option *ngFor="let t of terceiros()" [ngValue]="t.id">{{ t.nome || t.razaoSocial || ('#' + t.id) }}</option>
                </select>
              </td>

              <td>
                <select class="form-select form-select-sm"
                        [ngModel]="l.situacao"
                        [ngModelOptions]="{standalone:true}"
                        #sit="ngModel">
                  <option *ngFor="let s of situacoes" [ngValue]="s">{{ s }}</option>
                </select>
              </td>

              <td class="text-end">
                <button class="btn btn-sm btn-success me-2"
                        (click)="atualizar(
                          l.id,
                          {
                            descricao: d.value,
                            parcela: par.value,
                            dataLancamentoISO: dl.value || null,
                            dataVencimentoISO: dv.value || null,
                            dataBaixaISO: db.value || null,
                            valorDocumento: toNumber(vd.value),
                            valorBaixado: toNumber(vb.value),
                            tipoLancamento: tp.value,
                            situacao: sit.value,
                            contaId: conta.value != null ? toNumber(conta.value) : null,
                            centroCustoId: cc.value != null ? toNumber(cc.value) : null,
                            terceiroId: ter.value != null ? toNumber(ter.value) : null
                          }
                        )"
                        [disabled]="carregando()">Salvar</button>

                <button class="btn btn-sm btn-outline-danger"
                        (click)="remover(l.id)"
                        [disabled]="carregando()">Excluir</button>
              </td>
            </tr>

            <tr *ngIf="!lancamentos().length">
              <td colspan="14" class="text-center text-muted py-4">Nenhum lançamento cadastrado.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
